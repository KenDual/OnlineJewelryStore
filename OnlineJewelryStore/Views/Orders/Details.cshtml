@model OnlineJewelryStore.Models.Order
@{
   ViewBag.Title = "Order Details";
   Layout = "~/Views/Shared/_Layout.cshtml";
   var payment = Model.Payments.FirstOrDefault();
}

<style>
   .info-box {
      background: #fff;
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
   }

      .info-box h4 {
         font-size: 16px;
         font-weight: 600;
         margin-bottom: 15px;
         padding-bottom: 10px;
         border-bottom: 2px solid #f5f5f5;
         color: #333;
      }

   .info-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
   }

      .info-row:last-child {
         border-bottom: none;
      }

   .info-label {
      width: 140px;
      font-weight: 500;
      color: #666;
      font-size: 14px;
   }

   .info-value {
      flex: 1;
      color: #333;
      font-size: 14px;
   }

   .order-items-table {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
   }

      .order-items-table table {
         margin-bottom: 0;
      }

      .order-items-table thead {
         background: #f8f9fa;
      }

      .order-items-table th {
         font-weight: 600;
         color: #333;
         font-size: 14px;
         border-bottom: 2px solid #e0e0e0;
      }

      .order-items-table td {
         vertical-align: middle;
         font-size: 14px;
      }

   .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
   }

   .variant-badge {
      display: inline-block;
      background: #f5f5f5;
      padding: 3px 8px;
      margin: 2px;
      font-size: 11px;
      border-radius: 3px;
      color: #666;
   }

   .price-summary {
      background: #fff;
      border: 1px solid #e0e0e0;
      padding: 20px;
      border-radius: 4px;
   }

   .price-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
      font-size: 14px;
   }

      .price-row:last-child {
         border-bottom: none;
      }

      .price-row.total {
         font-size: 18px;
         font-weight: 700;
         color: #333;
         border-top: 2px solid #333;
         padding-top: 15px;
         margin-top: 10px;
      }

      .price-row.discount {
         color: #dc3545;
      }

   .action-buttons {
      margin-top: 20px;
   }

      .action-buttons .btn {
         margin-right: 10px;
         margin-bottom: 10px;
      }

   .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #666;
      text-decoration: none;
      font-size: 14px;
   }

      .back-link:hover {
         color: #333;
      }

      .back-link i {
         margin-right: 5px;
      }
</style>

<div class="body-popup-modal-area">
   <span class="modal-close">
      <img src="~/Resources/img/cancel.png" alt="Close" class="img-fluid" />
   </span>
   <div class="modal-container d-flex">
      <div class="search-box-area">
         <div class="search-box-form">
            <form action="#" method="post">
               <input type="search" placeholder="type keyword and hit enter" />
               <button class="btn" type="button">
                  <i class="fa fa-search"></i>
               </button>
            </form>
         </div>
      </div>
   </div>
</div>

<!--== Page Title Area Start ==-->
<div id="page-title-area">
   <div class="container">
      <div class="row">
         <div class="col-12 text-center">
            <div class="page-title-content">
               <h1>Order Details</h1>
               <ul class="breadcrumb">
                  <li><a href="@Url.Action("Index", "Home")">Home</a></li>
                  <li><a href="@Url.Action("Index", "Orders")">Orders</a></li>
                  <li><a href="#" class="active">Order #@Model.OrderID</a></li>
               </ul>
            </div>
         </div>
      </div>
   </div>
</div>

<!--== Page Content Wrapper Start ==-->
<div id="page-content-wrapper" class="p-9">
   <div class="container">
      <div class="row">
         <div class="col-lg-12">
            <div class="myaccount-page-wrapper">
               <div class="row">
                  <!-- Sidebar -->
                  <div class="col-lg-3">
                     <div class="myaccount-tab-menu nav" role="tablist">
                        <a href="@Url.Action("Index","UserDashboard")">
                           <i class="fa fa-dashboard"></i> Dashboard
                        </a>
                        <a href="@Url.Action("Index","Orders")" class="active">
                           <i class="fa fa-cart-arrow-down"></i> Orders
                        </a>
                        <a href="@Url.Action("Index","Addresses")">
                           <i class="fa fa-map-marker"></i> Address
                        </a>
                        <a href="@Url.Action("AccountDetails","UserDashboard")">
                           <i class="fa fa-user"></i> Account Details
                        </a>
                        <a href="@Url.Action("Login","Account")">
                           <i class="fa fa-sign-out"></i> Logout
                        </a>
                     </div>
                  </div>

                  <!-- Main Content -->
                  <div class="col-lg-9 mt-5 mt-lg-0">
                     <div class="tab-content">
                        <div class="tab-pane fade show active">
                           <div class="myaccount-content">
                              <!-- Back Link -->
                              <a href="@Url.Action("Index", "Orders")" class="back-link">
                                 <i class="fa fa-arrow-left"></i> Back to Orders
                              </a>

                              <!-- Order Header -->
                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                 <h3 style="margin: 0;">Order #@Model.OrderID</h3>
                                 @if (Model.Status == "Pending")
                                 {
                                    <span class="badge badge-warning" style="font-size: 14px; padding: 8px 15px;">@Model.Status</span>
                                 }
                                 else if (Model.Status == "Processing")
                                 {
                                    <span class="badge badge-info" style="font-size: 14px; padding: 8px 15px;">@Model.Status</span>
                                 }
                                 else if (Model.Status == "Shipped")
                                 {
                                    <span class="badge badge-primary" style="font-size: 14px; padding: 8px 15px;">@Model.Status</span>
                                 }
                                 else if (Model.Status == "Delivered")
                                 {
                                    <span class="badge badge-success" style="font-size: 14px; padding: 8px 15px;">@Model.Status</span>
                                 }
                                 else if (Model.Status == "Cancelled")
                                 {
                                    <span class="badge badge-danger" style="font-size: 14px; padding: 8px 15px;">@Model.Status</span>
                                 }
                              </div>

                              <!-- Success/Error Messages -->
                              @if (TempData["SuccessMessage"] != null)
                              {
                                 <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    @TempData["SuccessMessage"]
                                    <button type="button" class="close" data-dismiss="alert">
                                       <span>&times;</span>
                                    </button>
                                 </div>
                              }
                              @if (TempData["ErrorMessage"] != null)
                              {
                                 <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    @TempData["ErrorMessage"]
                                    <button type="button" class="close" data-dismiss="alert">
                                       <span>&times;</span>
                                    </button>
                                 </div>
                              }

                              <!-- Order & Payment Info Row -->
                              <div class="row">
                                 <div class="col-md-6">
                                    <div class="info-box">
                                       <h4><i class="fa fa-file-text-o"></i> Order Information</h4>
                                       <div class="info-row">
                                          <div class="info-label">Order Date:</div>
                                          <div class="info-value">@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                                       </div>
                                       <div class="info-row">
                                          <div class="info-label">Order Status:</div>
                                          <div class="info-value">
                                             @if (Model.Status == "Pending")
                                             {
                                                <span class="badge badge-warning">@Model.Status</span>
                                             }
                                             else if (Model.Status == "Processing")
                                             {
                                                <span class="badge badge-info">@Model.Status</span>
                                             }
                                             else if (Model.Status == "Shipped")
                                             {
                                                <span class="badge badge-primary">@Model.Status</span>
                                             }
                                             else if (Model.Status == "Delivered")
                                             {
                                                <span class="badge badge-success">@Model.Status</span>
                                             }
                                             else if (Model.Status == "Cancelled")
                                             {
                                                <span class="badge badge-danger">@Model.Status</span>
                                             }
                                          </div>
                                       </div>
                                       @if (Model.DeliveredAt != null)
                                       {
                                          <div class="info-row">
                                             <div class="info-label">Delivered At:</div>
                                             <div class="info-value">@Model.DeliveredAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                          </div>
                                       }
                                       @if (!string.IsNullOrEmpty(Model.GiftMessage))
                                       {
                                          <div class="info-row">
                                             <div class="info-label">Gift Message:</div>
                                             <div class="info-value">@Model.GiftMessage</div>
                                          </div>
                                       }
                                       @if (!string.IsNullOrEmpty(Model.CancellationReason))
                                       {
                                          <div class="info-row">
                                             <div class="info-label">Cancellation Reason:</div>
                                             <div class="info-value text-danger">@Model.CancellationReason</div>
                                          </div>
                                       }
                                    </div>
                                 </div>

                                 <div class="col-md-6">
                                    <div class="info-box">
                                       <h4><i class="fa fa-credit-card"></i> Payment Information</h4>
                                       @if (payment != null)
                                       {
                                          <div class="info-row">
                                             <div class="info-label">Payment Method:</div>
                                             <div class="info-value">
                                                @switch (payment.Method)
                                                {
                                                   case "COD":
                                                      <text>Cash on Delivery</text>
                                                      break;
                                                   case "Card":
                                                      <text>Credit/Debit Card</text>
                                                      break;
                                                   case "VNPay":
                                                      <text>VNPay</text>
                                                      break;
                                                   case "MoMo":
                                                      <text>MoMo Wallet</text>
                                                      break;
                                                   case "Bank":
                                                      <text>Bank Transfer</text>
                                                      break;
                                                   case "PayPal":
                                                      <text>PayPal</text>
                                                      break;
                                                   default:
                                                      @payment.Method
                                                      break;
                                                }
                                             </div>
                                          </div>
                                          <div class="info-row">
                                             <div class="info-label">Payment Status:</div>
                                             <div class="info-value">
                                                @if (payment.Status == "Captured")
                                                {
                                                   <span class="badge badge-success">@payment.Status</span>
                                                }
                                                else if (payment.Status == "Pending")
                                                {
                                                   <span class="badge badge-warning">@payment.Status</span>
                                                }
                                                else if (payment.Status == "Refunded")
                                                {
                                                   <span class="badge badge-info">@payment.Status</span>
                                                }
                                                else if (payment.Status == "Failed")
                                                {
                                                   <span class="badge badge-danger">@payment.Status</span>
                                                }
                                                else
                                                {
                                                   <span class="badge badge-secondary">@payment.Status</span>
                                                }
                                             </div>
                                          </div>
                                          <div class="info-row">
                                             <div class="info-label">Amount:</div>
                                             <div class="info-value"><strong>@payment.Amount.ToString("N0") @payment.Currency</strong></div>
                                          </div>
                                          if (!string.IsNullOrEmpty(payment.TransactionRef))
                                          {
                                             <div class="info-row">
                                                <div class="info-label">Transaction Ref:</div>
                                                <div class="info-value" style="font-family: monospace; font-size: 12px;">@payment.TransactionRef</div>
                                             </div>
                                          }
                                          if (payment.CapturedAt != null)
                                          {
                                             <div class="info-row">
                                                <div class="info-label">Captured At:</div>
                                                <div class="info-value">@payment.CapturedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                             </div>
                                          }
                                       }
                                       else
                                       {
                                          <p class="text-muted">No payment information available.</p>
                                       }
                                    </div>
                                 </div>
                              </div>

                              <!-- Shipping Address -->
                              <div class="info-box">
                                 <h4><i class="fa fa-map-marker"></i> Shipping Address</h4>
                                 <div class="info-row">
                                    <div class="info-label">Recipient:</div>
                                    <div class="info-value">@Model.User.FirstName @Model.User.LastName</div>
                                 </div>
                                 <div class="info-row">
                                    <div class="info-label">Address:</div>
                                    <div class="info-value">@Model.Address.StreetAddress</div>
                                 </div>
                                 <div class="info-row">
                                    <div class="info-label">City/State:</div>
                                    <div class="info-value">@Model.Address.City, @Model.Address.State</div>
                                 </div>
                                 <div class="info-row">
                                    <div class="info-label">Postal Code:</div>
                                    <div class="info-value">@Model.Address.PostalCode</div>
                                 </div>
                                 <div class="info-row">
                                    <div class="info-label">Country:</div>
                                    <div class="info-value">@Model.Address.Country</div>
                                 </div>
                                 <div class="info-row">
                                    <div class="info-label">Phone:</div>
                                    <div class="info-value">@Model.Address.Phone</div>
                                 </div>
                              </div>

                              <!-- Order Items -->
                              <div class="order-items-table">
                                 <h4 style="padding: 15px 20px; margin: 0; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                                    <i class="fa fa-shopping-cart"></i> Order Items
                                 </h4>
                                 <div class="table-responsive">
                                    <table class="table">
                                       <thead>
                                          <tr>
                                             <th style="width: 80px;">Image</th>
                                             <th>Product</th>
                                             <th style="width: 120px;">SKU</th>
                                             <th style="width: 80px;" class="text-center">Qty</th>
                                             <th style="width: 120px;" class="text-right">Unit Price</th>
                                             <th style="width: 120px;" class="text-right">Total</th>
                                          </tr>
                                       </thead>
                                       <tbody>
                                          @foreach (var item in Model.OrderItems)
                                          {
                                             var itemTotal = item.UnitPrice * item.Quantity;
                                             var mainImage = item.ProductVariant.Product.ProductMedias.FirstOrDefault(m => m.IsMain);
                                             <tr>
                                                <td>
                                                   @if (mainImage != null)
                                                   {
                                                      <img src="@mainImage.URL" alt="@item.ProductVariant.Product.ProductName" class="product-image" />
                                                   }
                                                   else
                                                   {
                                                      <img src="~/Resources/img/no-image.png" alt="No image" class="product-image" />
                                                   }
                                                </td>
                                                <td>
                                                   <div style="font-weight: 600; margin-bottom: 5px;">
                                                      @item.ProductVariant.Product.ProductName
                                                   </div>
                                                   <div>
                                                      @if (!string.IsNullOrEmpty(item.ProductVariant.MetalType))
                                                      {
                                                         <span class="variant-badge">@item.ProductVariant.MetalType</span>
                                                      }
                                                      @if (!string.IsNullOrEmpty(item.ProductVariant.Purity))
                                                      {
                                                         <span class="variant-badge">@item.ProductVariant.Purity</span>
                                                      }
                                                      @if (!string.IsNullOrEmpty(item.ProductVariant.RingSize))
                                                      {
                                                         <span class="variant-badge">Size: @item.ProductVariant.RingSize</span>
                                                      }
                                                      @if (!string.IsNullOrEmpty(item.ProductVariant.ChainLength))
                                                      {
                                                         <span class="variant-badge">Length: @item.ProductVariant.ChainLength</span>
                                                      }
                                                   </div>
                                                </td>
                                                <td style="font-family: monospace; font-size: 12px;">@item.ProductVariant.SKU</td>
                                                <td class="text-center">@item.Quantity</td>
                                                <td class="text-right">@item.UnitPrice.ToString("N0") đ</td>
                                                <td class="text-right"><strong>@itemTotal.ToString("N0") đ</strong></td>
                                             </tr>
                                          }
                                       </tbody>
                                    </table>
                                 </div>
                              </div>

                              <!-- Price Summary -->
                              <div class="row mt-4">
                                 <div class="col-md-6"></div>
                                 <div class="col-md-6">
                                    <div class="price-summary">
                                       <div class="price-row">
                                          <div>Subtotal:</div>
                                          <div>@Model.Subtotal.ToString("N0") đ</div>
                                       </div>
                                       @if (Model.TaxTotal > 0)
                                       {
                                          <div class="price-row">
                                             <div>Tax:</div>
                                             <div>@Model.TaxTotal.ToString("N0") đ</div>
                                          </div>
                                       }
                                       @if (Model.ShippingFee > 0)
                                       {
                                          <div class="price-row">
                                             <div>Shipping Fee:</div>
                                             <div>@Model.ShippingFee.ToString("N0") đ</div>
                                          </div>
                                       }
                                       @if (Model.DiscountTotal > 0)
                                       {
                                          <div class="price-row discount">
                                             <div>
                                                Discount
                                                @if (Model.Coupon != null)
                                                {
                                                   <text>(@Model.Coupon.Code - @Model.Coupon.PercentOff%)</text>
                                                }:
                                             </div>
                                             <div>-@Model.DiscountTotal.ToString("N0") đ</div>
                                          </div>
                                       }
                                       <div class="price-row total">
                                          <div>GRAND TOTAL:</div>
                                          <div>@Model.GrandTotal.ToString("N0") đ</div>
                                       </div>
                                    </div>
                                 </div>
                              </div>

                              <!-- Action Buttons -->
                              <div class="action-buttons">
                                 @if (Model.Status == "Pending")
                                 {
                                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#cancelOrderModal">
                                       <i class="fa fa-times"></i> Cancel Order
                                    </button>
                                 }

                                 <a href="@Url.Action("DownloadInvoice", "Orders", new { id = Model.OrderID })"
                                    class="btn btn-primary" target="_blank">
                                    <i class="fa fa-file-text-o"></i> View Invoice
                                 </a>

                                 <button type="button" class="btn btn-success" onclick="printInvoice(@Model.OrderID)">
                                    <i class="fa fa-print"></i> Print Invoice
                                 </button>

                                 <a href="@Url.Action("TrackOrder", "Orders", new { id = Model.OrderID })" class="btn btn-info">
                                    <i class="fa fa-truck"></i> Track Order
                                 </a>
                              </div>

                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" role="dialog" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
   <div class="modal-dialog" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Order #@Model.OrderID</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <form action="@Url.Action("CancelOrder", "Orders")" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="orderId" value="@Model.OrderID" />
            <div class="modal-body">
               <p>Are you sure you want to cancel this order? This action cannot be undone.</p>
               <div class="form-group">
                  <label for="cancellationReason">Reason for cancellation: <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="cancellationReason" name="cancellationReason" rows="4" required placeholder="Please tell us why you're cancelling this order..."></textarea>
                  <small class="form-text text-muted">
                     Examples: Changed my mind, Found better price, Ordered by mistake, etc.
                  </small>
               </div>
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
               <button type="submit" class="btn btn-danger">Confirm Cancellation</button>
            </div>
         </form>
      </div>
   </div>
</div>
<script>
function printInvoice(orderId) {
    var invoiceWindow = window.open('@Url.Action("DownloadInvoice", "Orders")?id=' + orderId, '_blank');
    invoiceWindow.onload = function() {
        invoiceWindow.print();
    };
}
</script>
